<!--
  ~ Copyright (c) 2015 WSO2 Inc. (http://www.wso2.org) All Rights Reserved.
  ~
  ~ WSO2 Inc. licenses this file to you under the Apache License,
  ~ Version 2.0 (the "License"); you may not use this file except
  ~ in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing,
  ~ software distributed under the License is distributed on an
  ~ "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~ KIND, either express or implied.  See the License for the
  ~ specific language governing permissions and limitations
  ~ under the License.
  -->

<bpel:process name="${bpelProcessName}"
              targetNamespace="http://bpel.mgt.workflow.carbon.wso2.org/approvalProcess"
              suppressJoinFailure="yes"
              xmlns:ns1="http://callback.mgt.workflow.identity.carbon.wso2.org"
              xmlns:tns="http://bpel.mgt.workflow.carbon.wso2.org/approvalProcess"
              xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
              xmlns:htw="http://ht.bpel.mgt.workflow.identity.carbon.wso2.org/wsdl"
              xmlns:xsd="http://www.w3.org/2001/XMLSchema"
              xmlns:bsch="http://schema.bpel.mgt.workflow.carbon.wso2.org/"
              exitOnStandardFault="no">

    <bpel:import location="${bpelProcessName}Artifacts.wsdl"
                 namespace="http://bpel.mgt.workflow.carbon.wso2.org/approvalProcess"
                 importType="http://schemas.xmlsoap.org/wsdl/"/>

    <extensions>
        <extension
                namespace="http://docs.oasis-open.org/ns/bpel4people/bpel4people/200803"
                mustUnderstand="yes"/>
    </extensions>

    <bpel:partnerLinks>

        <bpel:partnerLink name="client"
                          partnerLinkType="tns:${bpelProcessName}PLT"
                          myRole="partnerRole"
                />
        <bpel:partnerLink name="callbackService" partnerLinkType="tns:callbackServicePLT"
                          partnerRole="callbackServicePartnerRole"></bpel:partnerLink>
        <bpel:partnerLink name="b4pApprovalPL" partnerLinkType="tns:${htServiceName}PLT" myRole="ApprovalCallbackRole"
                          partnerRole="approvalPartnerRole"></bpel:partnerLink>
    </bpel:partnerLinks>

    <bpel:variables>
        <bpel:variable name="input" messageType="tns:${bpelProcessName}RequestMessage"/>
        <bpel:variable name="callbackServiceRequest" messageType="ns1:onCallbackRequest">
            <bpel:from>
                <bpel:literal xml:space="preserve">
                <ns:onCallback xmlns:ns="http://callback.mgt.workflow.identity.carbon.wso2.org/xsd" >
	 				<ns:response>
	    				<ns:outputParams>
	      					<ns:name>ns:name</ns:name>
	      					<ns:value>ns:value</ns:value>
	    				</ns:outputParams>
	    				<ns:status>ns:status</ns:status>
	    				<ns:uuid>ns:uuid</ns:uuid>
	  				</ns:response>
				</ns:onCallback>
				</bpel:literal>
            </bpel:from>
        </bpel:variable>
        <bpel:variable name="approvalInput" messageType="htw:ApprovalRequest">
        </bpel:variable>
        <bpel:variable name="approvalOutput" messageType="htw:ApprovalResponse"></bpel:variable>
        <bpel:variable name="event" type="xsd:string">
            <bpel:from>
                <bpel:literal xml:space="preserve">NULL</bpel:literal>
            </bpel:from>
        </bpel:variable>
        <bpel:variable name="parameters" type="bsch:parameterList">
            <bpel:from>
                <bpel:literal xml:space="preserve"><![CDATA[]]></bpel:literal>
            </bpel:from>
        </bpel:variable>
        <bpel:variable name="paramString" type="xsd:string">
            <bpel:from>
                <bpel:literal></bpel:literal>
            </bpel:from>
        </bpel:variable>
    </bpel:variables>

    <bpel:sequence name="main">
        <bpel:receive name="receiveInput" partnerLink="client"
                      portType="tns:${bpelProcessName}"
                      operation="initiate" variable="input"
                      createInstance="yes"/>
        <bpel:assign validate="no" name="Assign">
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[bsch:parameters]]></bpel:query>
                </bpel:from>
                <bpel:to variable="parameters"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from part="payload" variable="input">
                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[bsch:eventType]]></bpel:query>
                </bpel:from>
                <bpel:to variable="event"></bpel:to>
            </bpel:copy>
            <bpel:copy>
                <bpel:from>
                    <bpel:literal xml:space="preserve"></bpel:literal>
                </bpel:from>
                <bpel:to variable="paramString"></bpel:to>
            </bpel:copy>
        </bpel:assign>
        <bpel:forEach parallel="no" counterName="Counter" name="ForEachParam">
            <bpel:startCounterValue>
                <![CDATA[1]]>
            </bpel:startCounterValue>
            <bpel:finalCounterValue>
                <![CDATA[count($input.payload/bsch:parameters/bsch:parameter)]]><!-- count(bsch:parameters/bsch:parameter) -->
            </bpel:finalCounterValue>
            <bpel:scope>
                <bpel:sequence>
                    <bpel:assign validate="no" name="concatParameterName">
                        <bpel:copy>
                            <bpel:from queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"
                                       expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[concat($paramString,$input.payload/bsch:parameters/bsch:parameter[round($Counter)]/@name,":","[")]]>
                            </bpel:from>
                            <bpel:to variable="paramString"></bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                    <bpel:forEach parallel="no" counterName="ItemNumber" name="ForEachListItem">
                        <bpel:startCounterValue expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[1]]>
                        </bpel:startCounterValue>
                        <bpel:finalCounterValue expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                            <![CDATA[count($input.payload/bsch:parameters/bsch:parameter[round($Counter)]/bsch:value)]]></bpel:finalCounterValue>
                        <bpel:completionCondition></bpel:completionCondition>
                        <bpel:scope>
                            <bpel:sequence>
                                <bpel:if name="If">
                                    <bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                        <![CDATA[$input.payload/bsch:parameters/bsch:parameter[round($Counter)]/bsch:value[round($ItemNumber)]/bsch:itemName]]></bpel:condition>
                                    <bpel:assign validate="no" name="concatItemName">
                                        <bpel:copy>
                                            <bpel:from
                                                    expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                <![CDATA[concat($paramString,$input.payload/bsch:parameters/bsch:parameter[round($Counter)]/bsch:value[round($ItemNumber)]/bsch:itemName,":")]]>
                                            </bpel:from>
                                            <bpel:to variable="paramString"></bpel:to>
                                        </bpel:copy>
                                    </bpel:assign>
                                </bpel:if>
                                <bpel:assign validate="no" name="concatItemValue">
                                    <bpel:copy>
                                        <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                            <![CDATA[concat($paramString,$input.payload/bsch:parameters/bsch:parameter[round($Counter)]/bsch:value[round($ItemNumber)]/bsch:itemValue,",")]]>
                                        </bpel:from>
                                        <bpel:to variable="paramString"></bpel:to>
                                    </bpel:copy>

                                </bpel:assign>
                            </bpel:sequence>
                        </bpel:scope>
                    </bpel:forEach>
                    <bpel:assign validate="no" name="concatClosingTags">
                        <bpel:copy>
                            <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                <![CDATA[concat($paramString,"]",",")]]>
                            </bpel:from>
                            <bpel:to variable="paramString"></bpel:to>
                        </bpel:copy>
                    </bpel:assign>
                </bpel:sequence>
            </bpel:scope>
        </bpel:forEach>
    </bpel:sequence>
</bpel:process>

